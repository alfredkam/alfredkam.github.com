<!DOCTYPE html>



 <html class="no-js"> 
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Npm</title>

        <link rel='stylesheet' href='/css/prismjs/prism-okaidia.css' />

        
        <link rel="stylesheet" href="/css/fontello-f19985b1/css/fontello.css" />
        <link rel="stylesheet" href="/css/fontello-f19985b1/css/animation.css" />
        

        
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,500,300,300italic,400italic,500italic' rel='stylesheet' type='text/css'>

        
        <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.indigo-pink.min.css">
        <script src="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

        
        <link rel="stylesheet" href="/scripts/styles.css">
    </head>

    <body>
        <header>
    
    <nav class="navbar" role="navigation">
        <div class='container'>
          <div class="navbar--title navbar__item">
              <a href='/'>Geeking out</a>
          </div>
          <div id='SearchComponent' class='navbar__item navbar__item--align-right'>
          </div>
        </div>
    </nav>
    <div class='header-bg'></div>
</header>

        <div class='container'>

            <h1 id="title">Npm</h1>

            
                  <section class='posts row'>
  <div class='posts--wide mdl-card mdl-shadow--2dp posts__content'>
    <h2><a href="http://alfredkam.com/using-git-hooks-to-deploy-server-with-forever">using git hooks to deploy server with forever</a></h2>
    <p class="author">
      <span class="date">Mon Feb 17, 2014</span>
    </p>
    <div class="content">
      <p>If you love deploying with automation and you love the fact you dont need to touch your server (which you should!).  I've setup this up on an ec2 ubuntu 12.04 LTS, shouldnt differ too much with other ubuntu versions.  At this time of writing i'm setting up a nodejs / flask server</p>
<p>On your remote server</p>
<pre><code class='language-markup'>
#install forever and give it global access
sudo npm install -g forever
</code></pre>
<pre class='language-markup'><code>
#setup git bare at your deployment server
git clone --bare [repo url]
</code></pre>
<pre class='language-markup'><code>
#add the hooks
#navigate into your git folder
cd path/to/repo/hooks
vi pre-receive
</code></pre>
<pre class='language-bash'><code>
#!/bin/sh
echo "stopping server service"
service nodejs-www stop
</code></pre>
<pre class='language-bash'><code>
vi post-receive
</code></pre>
<pre class='language-bash'><code>
#!/bin/sh
echo "checkout the files"

branch=$(git branch | grep "*" | sed "s/* //")

if [ "$branch" = "master" ]
then
        echo "Master branch"
        git --work-tree=/home/ubuntu/app/www checkout -f
        echo "Successfully checked out master branch"
else
        echo "Not master branch"
fi

echo "start service"
service nodejs-www start
</code></pre>
<pre class='language-markup'><code>
sudo chmod +x pre-receive;
sudo chmod +x post-receive;
</code></pre>
<p>FYI: Just make sure the folders are created for the "git --work-tree"</p>
<pre><code class='language-markup'>
#navigate into init.d to create a service
cd /etc/init.d
sudo vi nodejs-www
</code></pre>
<pre class='language-bash'><code>
#! /bin/sh
# /etc/init.d/nodejs-www
#

NAME=nodejs-www
APP=index.js
APP_DIR=/home/ubuntu/app/www
forever=/usr/local/bin/forever
export PATH=$PATH:/usr/local/bin/
LOG=/var/log/nodejs-www.log

case "$1" in
  start)
    cd $APP_DIR
    echo "Starting $NAME"
    #I detached the message to 'screen', it is not a requirement
    screen -d -m /usr/bin/sudo -u ubuntu $forever --minUptime 5000 --spinSleepTime 2000 -a -l $LOG start $APP
    #if to run a python server use
    #screen -d -m /usr/bin/sudo -u ubuntu $forever --minUptime 5000 --spinSleepTime 2000 -a -l $LOG start -c python $APP
    echo "Started $Name"
    exit 0
    ;;
  stop)
    echo "Stopping script $NAME"
    cd $APP_DIR
    /usr/bin/sudo -u ubuntu $forever stop $APP
    exit 0
    ;;
  list)
    echo "List"
    /usr/bin/sudo -u ubuntu $forever list
    exit 0
    ;;
  *)
    echo "Usage: /etc/init.d/nodejs-www {start|stop|list}"
    exit 1
    ;;
esac

exit 0
</code></pre>
<p>FYI: Many others were able to run forever directly without having "/usr/bin/sudo -u ubuntu" (ubuntu is the user account) or substituting it with "sudo".  For my case on an amazon aws, without it, i ran into permission issues with forever and nodejs directory mapping issues.</p>
<p>A permission error similar to this:</p>
<pre><code class='language-javascript'>
fs.js:0
(function (exports, require, module, __filename, __dirname) { // Copyright Joy
^
Error: EACCES, permission denied '/root/.forever/pids/FepR.pid'
    at Object.fs.openSync (fs.js:410:18)
    at Object.fs.writeFileSync (fs.js:956:15)
    at writePid (/usr/local/lib/node_modules/forever/bin/monitor:13:6)
    at null.<anonymous> (/usr/local/lib/node_modules/forever/bin/monitor:46:5)
    at EventEmitter.emit (/usr/local/lib/node_modules/forever/node_modules/forever-monitor/node_modules/broadway/node_modules/eventemitter2/lib/eventemitter2.js:332:22)
    at /usr/local/lib/node_modules/forever/node_modules/forever-monitor/lib/forever-monitor/monitor.js:153:10
</code></pre>
<p>Now to wrap up the server side</p>
<pre><code class='language-markup'>
sudo chmod a+x nodejs-www
cd /var/log
sudo touch nodejs-www.log
sudo chmod 777 nodejs-www.log
</code></pre>
<p>Add to rc.local to start upon server start</p>
<pre><code class='language-markup'>
sudo vi /etc/rc.local
</code></pre>
<pre><code class='language-markup'>
#!/bin/sh -e
service nodejs-www start
exit 0
</code></pre>
<p>For some you may need to change the rc.local permission to executable.</p>
<p>If i didnt miss anything this should it for the server</p>
<p>Now on client side</p>
<pre><code class='language-markup'>
cd path/to/repo
git remote add deploy [remote server repo url]
git commit -am 'test deploy'
git push deploy master
</code></pre>
<p>This should be it, and the service should automatically stop and restart itself.  If i missed anything let me know :)</p>

    </div>
  </div>
</section>

            
            
        </div>
    </body>
    <style>
        h1#title {
            text-align: center;
            font-weight: bold;
        }
    </style>
<footer>
  <div class='container'>
      <div class='footer'>
        <div class='footer__item'>
          <h4>
            About
          </h4>
          <div>
            <div class='footer__portrait'>
              <img src='http://www.gravatar.com/avatar/d9b3f7a32a3bf559aad23694c73eb8cc.png' style='width:100%'></img>
            </div>
            <p class='col-xs-8'>
              Hello! I'm Alfred.  I'm an entrepenuer at heart and love to work on ideas that can impact millions.  Feel free to reach out to me!
            </p>
          </div>
        </div>
        <div class='footer__item'>
          <h4>
            Notable Works
          </h4>
          <p>
            <a href='http://appfuel.me'>Appfuel (Acq. by Tune)</a><br>
            <a href='http://phylo.cs.mcgill.ca'>PHYLO</a><br>
            <a href='https://github.com/alfredkam/yakojs'>Yako</a><br>
            <a href='/portfolio'>> More</a>
          </p>
        </div>
        <div class='footer__item'>
          <h4>
            Stalking Aids
          </h4>
          <p class='footer__social-btn'>
            <a href='http://github.com/alfredkam'><i class='icon-github'></i></a>
            <a href='https://twitter.com/alfredkam'><i class='icon-twitter'></i></a>
            <a href='http://www.linkedin.com/in/kamalfred'><i class='icon-linkedin'></i></a>
          </p>
        </div>
      </div>
      <div class='row'>
        <div class='col-md-12 copyright-info'>
          Alfred Kam &#169; 2015
        </div>
      </div>
  </div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('require', 'displayfeatures');
  ga('create', 'UA-25416273-1', 'alfredkam.com');
  ga('send', 'pageview');
</script>
<scrpit src='/scripts/vendor.js' type='text/javascript'></script>
<script src='/scripts/app.js' type='text/javascript'></script>

</footer>
</html>

